/*
 * File: app/controller/UserManagement.js
 * Date: Thu Aug 24 2023 19:15:49 GMT+0300 (East Africa Time)
 *
 * This file was generated by Sencha Architect version 4.3.4.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 7.5.x Classic library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 7.5.x Classic. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('PayrollApp.controller.UserManagement', {
    extend: 'Ext.app.Controller',
    alias: 'controller.usermanagement',

    views: [
        'UserManagement',
        'NewUserForm'
    ],

    refs: {
        newuserform: {
            selector: 'newuserform',
            xtype: 'newuserform'
        },
        usermanagement: {
            selector: 'usermanagement',
            xtype: 'usermanagement'
        }
    },

    control: {
        "#cmdSaveUser": {
            click: 'onButtonClick'
        }
    },

    onButtonClick: function(button, e, eOpts) {

    },

    loadUserRoles: function(gridpanel, record, item, index, e, eOpts) {
        var ids=record.get('Roles');

        var userRoles=Ext.data.StoreManager.lookup('UserRolesStore');
        userRoles.load({
            params: {
                ids: ids
            },
            callback: function(records, operation, success) {

            },
            scope: this

        });
    },

    openUserForm: function(button) {
        userform= Ext.create('PayrollApp.view.NewUserForm', {});
        var usersWin=Ext.create('Ext.window.Window', {
            title: 'New User Form',
            animCollapse: true,
            collapsible: true,
            tools: [
            {
                xtype: 'tool',
                type: 'minimize'
            },
            {
                xtype: 'tool',
                type: 'maximize'
            }
            ]
        });


        userform.query('textfield[name="formStatus"]')[0].setValue('insert');


        usersWin.add(userform);
        usersWin.show();
    },

    init: function(application) {
        this.control({
            '#usersGrid':{
                itemclick:this.loadUserRoles,
                itemdblclick:this.viewUserDetails
            },
            '#cmdNewUser':{
                click:this.openUserForm
            },
            '#cmdSaveUser':{
                click:this.saveUser
            },
            //'#usersGrid':{
             //   itemdblclick:this.viewUserDetails
           //},
            'usermanagement actioncolumn[id=deleteUser]':{
                click:this.deleteUser
            }
        });
    },

    saveUser: function(button) {
        var form = button.up('form').getForm(); // get the basic form
        var pass1=button.up('form').getForm().findField('password1').getValue();
        var pass2=button.up('form').getForm().findField('password2').getValue();

        if(pass1!=pass2){
            Ext.Msg.alert('Confirm Password','Sorry the two passwords do not match <br>'+pass1);
        }else{
            if (form.isValid()) { // make sure the form contains valid data before submitting
            form.submit({
                params:{
                    //password:CryptoJS.MD5(pass1)
                    password:pass1
                },
                success: function(form, action) {
                    Ext.Msg.alert('Success', 'Saved new Item successfully.');

                    var win = button.up('window');
                    win.removeAll();
                    win.close();

                    var userInfo=Ext.data.StoreManager.lookup('UsersListStore');
                    userInfo.load({});

                },
                failure: function(form, action) {
                        Ext.Msg.alert('Failed', 'Error updating company please check your input values');
                }
            });
        } else { // display error alert if the data is invalid
            Ext.Msg.alert('Invalid Data', 'Please correct form errors.');
        }
        }


    },

    viewUserDetails: function(gridpanel, record, item, index, e, eOpts) {
        userform= Ext.create('PayrollApp.view.NewUserForm', {});
        var usersWin=Ext.create('Ext.window.Window', {
            title: 'User Details Form',
            animCollapse: true,
            collapsible: true,
            tools: [
            {
                xtype: 'tool',
                type: 'minimize'
            },
            {
                xtype: 'tool',
                type: 'maximize'
            }
            ]
        });


        userform.query('textfield[name="formStatus"]')[0].setValue('update');

        usersWin.add(userform);
        usersWin.show();

        userform.getForm().loadRecord(record);
    },

    deleteUser: function(gridpanel, record, item, index, e, eOpts) {

        var username=record.get('Username');

            Ext.Msg.show({
                title:'Delete User?',
                msg: 'Are you sure you want to delete '+username,
                buttons: Ext.Msg.YESNOCANCEL,
                icon: Ext.Msg.QUESTION,
                fn: function(rec) {
                    if (rec === "yes") {
                        Ext.Ajax.request({
                            url: 'data/UserManagement.php?task=deleteUser',
                            params: {
                                userName:username
                            },
                            waitMsg: 'Deleting User ...',
                            success: function(response){
                                var text = response.responseText;
                                Ext.Msg.alert('Delete','Record Successfully deleted');
                                var userslist=Ext.data.StoreManager.lookup('UsersListStore');
                                userslist.load({});

                            },
                            failure:function(response){
                                var resp = JSON.parseJSON(response);
                                Ext.Msg.alert('Error','There was a problem deleting the User, Contact System Administrator');
                            }
                        });

                    }
                }
            });
    }

});
