/*
 * File: app/controller/MyController.js
 *
 * This file was generated by Sencha Architect version 2.2.3.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 4.2.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 4.2.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('MyApp.controller.MyController', {
    extend: 'Ext.app.Controller',
    alias: 'controller.security',

    models: [
        'Users'
    ],
    views: [
        'loginform'
    ],

    refs: [
        {
            ref: 'loginform',
            selector: 'loginform',
            xtype: 'loginform'
        }
    ],

    init: function(application) {
        this.control({
            '#cmdLogin':{
                click:this.getLoginDetails
            },
            '#cmdCancelLogin':{
                click:this.closLogin
            }
        });


        this.listen({
            global: {
                beforeloginwindowrender: this.processLoggedIn
            }
        });
    },

    doLogin: function(button, e, eOpts) {
        Ext.Msg.alert('test');
    },

    dologout: function(button, e, eOpts) {
        Ext.Msg.alert('test');
    },

    processLoggedIn: function() {
        var me = this;
        // make remote request to check session

        loginform= Ext.create('PayrollApp.view.LoginForm', {});
        var loginWindow=Ext.create('Ext.window.Window', {
            title: 'Login window',
            animCollapse: true,
            collapsible: true,
            tools: [
            {
                xtype: 'tool',
                type: 'minimize'
            },
            {
                xtype: 'tool',
                type: 'maximize'
            }
            ]
        });


        Ext.Ajax.request({
            url: 'data/getDataFunctions.php?task=checkLogin',
            success: function( response, options ) {
                var result = Ext.decode( response.responseText );
                if( result.success ) {
                    // has session...add to application stack
                    LoggedInUser = Ext.create( 'PayrollApp.model.Users', result.data );
                    // fire global event aftervalidateloggedin
                    //Ext.globalEvents.fireEvent( 'aftervalidateloggedin' );
                    loginform.close();
                    Ext.create( 'PayrollApp.view.PayrollMain' );

                } 
                // couldn't login...show error
                else {
                    Ext.Msg.alert('Loging Error','Error trying to Login,Check our username and Password');
                    loginWindow.add(loginform);
                    loginWindow.show();
                }
            },
            failure: function( response, options ) {
                Ext.Msg.alert( 'Attention', 'Sorry, an error occurred during your request. Please try again.' );
            }
        });
    },

    setupApplication: function() {
        Ext.create( 'PayrollApp.view.PayrollMain' );

    }

});
